---
title: "Predicting CPI for Alcoholic Beverages and Tobacco with Time Series Regression"
author: "Muhammet Enes Üstün"
date: "02 05 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
	warning = FALSE)
```

## Introduction
   
  In this exercise, aim is to construct a time regression model for predicting a macroeconomic variable Consumer Price Index for Alcoholic Beverages and Tobacco using recent values of CPI, USD-TL Exchange Rate, Consumer Confidence Index, Interest Rate for Loan. Datas were gathered from [EVDS](https://evds2.tcmb.gov.tr/) System of Central Bank of Turkey. 

---

  Required packages are used. These will be help us for visualization and manipulation of data and statistical operations.

```{r}
library(ggplot2)
library(ggcorrplot)
library(fpp)
library(data.table)
library(GGally)        
library(readxl)
library(forecast)
```

---

  Gathered data from EVDS is read and time series data is obtained.

```{r}
data = read_excel("DATA_HW2.xlsx")
data = as.data.table(data)
data$Date = as.Date(data$Date)
```

---

  Let's graph the CPI for Alcoholic Beverages and Tobacco between 01.2012 and 03.2021


```{r}
ggplot(data, aes(x=Date, y=CPI_ALC_TOB)) + geom_line(size = 2, colour = "darkred") + labs(x = "Time (Years)", y = "CPI for Alcoholic Bev. and Tobacco",
title="Monthly CPI Over Years") + geom_smooth(method = "lm")
```

  Let's take logarithm because trend does not seem linear throughout time especially after 2019, and plot it.


```{r}
data$CPI_ALC_TOB = log(data$CPI_ALC_TOB)

ggplot(data, aes(x=Date, y=CPI_ALC_TOB)) + geom_line(size = 2, colour = "orange") + labs(x = "Time (Years)", y = "log (CPI for Alcoholic Bev. and Tobacco)",
title="Monthly log(CPI) Over Years") + geom_smooth(method = "lm")

```
  
---

  Let's look at cross correlations between selected variables.


```{r}
ggpairs(data)
```

  When we look at correlations, it is obvious that with 0.951, USD/TL Exchange Rate highly correlated with Price Index of Alcoholic beverages and tobacco. Most probably it holds because they are imported to Turkey and purchased with Dollar.

---

```{r}
pacf(data$CPI_ALC_TOB, lag.max = 12,  na.action = na.pass)
```
 
 
  From the above table we can see that we have 1 period lag. Rest is not important, therefore we will use lag-1 in our analysis.

---

## Regression Models
  
  
  Let's start to build some models and investigate them. At each model, you will see summary of model, residuals analysis and plot of predicted values generated by that model vs actual values.
  
  The huge shift in 2019 may be stem from exchange crisis happened in Turkey at 2018 Summer. That's why we start to construct a model with USD_TL Exchange Rate.

```{r}
model1<- lm(CPI_ALC_TOB ~ USD_TL, data=data)
summary(model1)
checkresiduals(model1)
data[,Fitted11:=predict(model1,data)]
cols <- c("Predicted" = "darkred", "Actual" = "blue")
ggplot(data ,aes(x=Date)) + geom_line(aes(y=CPI_ALC_TOB,color='Actual')) + geom_line(aes(y=Fitted11,color='Predicted')) + scale_color_manual(values = cols) +
labs(x = "Time (Years)", y = "log(CPI for Alcoholic Bev. and Tobacco)",
     title="Actual vs. Predicted Values of CPI for Alcoholic Beverages and Tobacco")
```

  Not a bad consequence for first trial. Not surprisingly, USD_TL exchange rate is significant for our model. Let's try other regressors to improve our model; decreasing Residual Standard Error, increasing R-Squared value and not autocorrelated, having mean approximately zero and constant variance. 


```{r}
model2<- lm(CPI_ALC_TOB ~ USD_TL + CCI, data)
summary(model2)
checkresiduals(model2)
data[,Fitted2:=predict(model2,data)]
cols <- c("Predicted" = "darkred", "Actual" = "blue")
ggplot(data ,aes(x=Date)) + geom_line(aes(y=CPI_ALC_TOB,color='Actual')) + geom_line(aes(y=Fitted2,color='Predicted')) + scale_color_manual(values = cols) +
labs(x = "Time (Years)", y = "log(CPI for Alcoholic Bev. and Tobacco)",
     title="Actual vs. Predicted Values of CPI for Alcoholic Beverages and Tobacco")
```

  CCI is not significant. Let's remove it and add Interest rate to our model.

```{r}


model3<- lm(CPI_ALC_TOB ~ USD_TL + Int_Rate, data)
summary(model3)
checkresiduals(model3)
data[,Fitted3:=predict(model3,data)]
cols <- c("Predicted" = "darkred", "Actual" = "blue")
ggplot(data ,aes(x=Date)) + geom_line(aes(y=CPI_ALC_TOB,color='Actual')) + geom_line(aes(y=Fitted3,color='Predicted')) + scale_color_manual(values = cols) +
labs(x = "Time (Years)", y = "log(CPI for Alcoholic Bev. and Tobacco)",
     title="Actual vs. Predicted Values of CPI for Alcoholic Beverages and Tobacco")

```

  R-squared value is improved to 0.9137 all variables are significant now. Also Residual Standard Error has decreased. When we look at ACF, we see that there is autocorrelations between residuals. That's why we should try another models to improve R-Squared value and residuals not autocorrelated.

```{r}
data$trend <- 1:nrow(data)
model0=lm(CPI_ALC_TOB ~ trend, data)
data[,trendvar:=predict(model0,data)]

model4=lm(CPI_ALC_TOB ~ trendvar + USD_TL + Int_Rate ,data)
summary(model4)
checkresiduals(model4)

data[,Fitted0:=predict(model4,data)]
cols <- c("Predicted" = "darkred", "Actual" = "blue")
ggplot(data ,aes(x=Date)) + geom_line(aes(y=CPI_ALC_TOB,color='Actual')) + geom_line(aes(y=Fitted0,color='Predicted')) + scale_color_manual(values = cols) +
labs(x = "Time (Years)", y = "log(CPI for Alcoholic Bev. and Tobacco)",
     title="Actual vs. Predicted Values of CPI for Alcoholic Beverages and Tobacco")

```

  Now, R-Squared value has increased, also all regressors are significant. Residual standard error at its lowest value which is 0.05289. Autocorrelations seem lower at this model and they are somehow between boundaries.

```{r}
data[, residuals:=residuals(model4)]
data[, Lagged:=shift(residuals(model4),1)]

finalmodel = lm(CPI_ALC_TOB ~ trendvar + USD_TL + Int_Rate + Lagged, data)
summary(finalmodel)
checkresiduals(finalmodel)

data[,Fitted1:=predict(finalmodel,data)]

cols <- c("Predicted" = "darkred", "Actual" = "blue")
ggplot(data ,aes(x=Date)) + geom_line(aes(y=CPI_ALC_TOB, color='Actual')) + geom_line(aes(y=Fitted1,color='Predicted')) + scale_color_manual(values = cols) +
  labs(x = "Time (Years)", y = "log(CPI for Alcoholic Bev. and Tobacco", title="Actual vs. Predicted Values of CPI for Alcoholic Beverages and Tobacco")
```

  Our R-Squared value now is 0.9917 which is highest and residual standard error is 0.02797 that is lowest. Residuals seems more normally distributed, having nearly 0 mean and not autocorrelated. All of them are between boundaries.
  
  Graph also shows that our model fitted well to our time series data. We can use this model to forecast April 2021.
  
---
  
## Forecasting

  Forecast April 2021 value.

```{r}
data=rbind(data, data.table(Date = as.Date("2021-04-01")),fill=TRUE )
predict(data$Lagged)
data$Lagged[112]=-0.0001837901
predict(data$Int_Rate)
data$Int_Rate[112]=22.75589
predict(data$USD_TL)
data$USD_TL[112]=7.694781

data$trend <- 1:nrow(data)
model0=lm(CPI_ALC_TOB~trend,data)
data[,trendvar:=predict(model0,data)]

exp(predict(finalmodel, data[is.na(CPI_ALC_TOB) == TRUE]))
```

  We should not forget that we have taken the logarithm of CPI. Again we take exponential of it, and plot the graph.

```{r}
data[,Fitted1:=predict(finalmodel,data)]
data$CPI_ALC_TOB <- exp(data$CPI_ALC_TOB)
data$predictnewdata <- exp(data$Fitted1)
cols <- c("Predicted" = "black", "Actual" = "blue")
ggplot() + geom_line(data = data, aes(x = Date, y = predictnewdata, color = "Predicted",)) + geom_line(data = data, aes(x = Date, y = CPI_ALC_TOB, color = "Actual")) + xlab('Time (Years)') + ylab('CPI For Alcoholic Bev. and Tobacco') + labs(title="Actual vs. Predicted Values of CPI for Alcoholic Beverages and Tobacco") + scale_color_manual(values = cols)

```

---

## Conclusion

  This study shows that we can predict future's CPI for Alcoholic Beverages and Tobacco using time series data for USD/TL exchange rate, interest rate paid on loans. Consumer Confidence Index did not work well constructing regression model, so we did not use it. Also 1 term lagged variable and trend variable improved our model. Residual standard error is 0.02793 which is good, our R-Squared value is 0.9917 and all regressors are significant. Residuals have approximately zero mean, constant variance and they are not autocorrelated. 
  Using past values, we have predicted April 2021 value of CPI for Alcoholic Beverages and Tobacco which is 916.9527.


---

## References and Legend

[EVDS System of Central Bank of Turkey](https://evds2.tcmb.gov.tr/index.php?/evds/serieMarket)


CPI for Alcoholic Beverages and Tobacco  -  TP.FG.J02	02.ALKOLLÜ İÇECEKLER VE TÜTÜN-Düzey	Gözlem Değeri: Orijinal Gözlem
USD/TL Exchange Rate  -  TP.DK.USD.A.YTL	(USD) ABD Doları (Döviz Alış)-Düzey	Gözlem Değeri: Orijinal Gözlem
Interest Rate  -  TP.KTF10	İhtiyaç (TL Üzerinden Açılan)(Akım Veri,%)-Düzey	Gözlem Değeri: Orijinal Gözlem
Consumer Confidence Index(CCI)  -  TP.TG2.Y01	Tüketici Güven Endeksi(*)-Düzey	Gözlem Değeri: Orijinal Gözlem
		
Notlar		
TP.DK.USD.A.YTL	Veri Kaynağı	TCMB
	Etiketler	Kurlar, Döviz, Kurları, Günlük
	
TP.KTF10	Veri Kaynağı	TCMB
	[Veri Yayınlama Takvim Linki](http://www3.tcmb.gov.tr/veriyaytakvim/takvim.php)
	Etiketler	kredi, faiz
	Dipnotlar	Bankaların geriye dönük düzeltmeleri nedeniyle zaman serilerinde güncelleme yapılabilmektedir.
	
TP.FG.J02	[Uygulama Değişiklik Linki](http://www.tuik.gov.tr/PreTablo.do?alt_id=114)
	Veri Kaynağı	TÜİK
	[Veri Yayınlama Takvim Linki](http://www.tuik.gov.tr/takvim/tkvim.zul#tb1)
	[Metaveri Linki](http://www.tuik.gov.tr/PreTablo.do?alt_id=114)
	[Revizyon Politika Linki](http://www.tuik.gov.tr/PreTablo.do?alt_id=114)
	Etiketler	Tüketici, Fiyat, Endeksi, TÜFE
	
TP.TG2.Y01	[Uygulama Değişiklik Linki](http://www.tuik.gov.tr/PreTablo.do?alt_id=114)
	Veri Kaynağı	TÜİK
	[Veri Yayınlama Takvim Linki](http://www.tuik.gov.tr/takvim/tkvim.zul#tb1)
	[Metaveri Linki](http://www.tuik.gov.tr/PreTablo.do?alt_id=114)
	[Revizyon Politika Linki](http://www.tuik.gov.tr/PreTablo.do?alt_id=114)
	Etiketler	Tüketici, Güven, Endeksi, ve, Tüketici, Eğilim, Anketi
	Dipnotlar	(*) Avrupa Komisyonu Ekonomik ve Finansal İşler Genel Müdürlüğü&#039;nün tavsiyeleri doğrultusunda ve endeksin uluslararası karşılaştırılabilirliğini sağlamak amacıyla Tüketici Güven Endeksi’nin hesaplama yöntemi güncellenmiştir.
	[For more information](http://www.tuik.gov.tr//duyurular/duyuru_4501.pdf) 


---